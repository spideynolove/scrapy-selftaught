define("metaserver/static/js/devtools/panels/performance/perf_hub_action_types",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PerfHubHeaderNames=t.ActionTypes=void 0,(function(e){e.PROFILED_AJAX_LOAD_FINISHED="PROFILED_AJAX_LOAD_FINISHED",e.WEB_TIMING_FETCHED="WEB_TIMING_FETCHED",e.VISUALLY_COMPLETE="VISUALLY_COMPLETE"})(t.ActionTypes||(t.ActionTypes={})),(function(e){e.SERVER_RESPONSE_TIME="x-server-response-time",e.REQUEST_PROFILE_ID="x-dropbox-request-profile-id",e.REQUEST_ID="x-dropbox-request-id",e.FORCE_REQUEST_TRACING_HEADER="x-dropbox-force-request-tracing"})(t.PerfHubHeaderNames||(t.PerfHubHeaderNames={}))})),define("metaserver/static/js/prod_assets_web_modules/@dropbox/ttvc",["exports"],(function(e){"use strict";const t={DEBUG:!1,IDLE_TIMEOUT:200,NETWORK_TIMEOUT:6e4};class i{static format(...e){return["[ttvc]",...e,"::",performance.now()]}static debug(...e){t.DEBUG&&console.debug(...this.format(...e))}static info(...e){t.DEBUG&&console.info(...this.format(...e))}static warn(...e){t.DEBUG&&console.warn(...this.format(...e))}}class s{constructor(){this.pendingRequests=0,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{i.debug("AjaxIdleObservable.next()",e),this.subscribers.forEach(t=>t(e))},this.startCleanupTimeout=()=>{0!==t.NETWORK_TIMEOUT&&(this.abortCleanupTimeout(),this.cleanupTimeout=window.setTimeout(()=>{i.warn("AjaxIdleObservable","::","Timed out waiting for requests to resolve.","Make sure that incrementAjaxCount() is always matched with decrementAjaxCount().","::","pendingRequests =",this.pendingRequests),this.didNetworkTimeOut=!0,this.pendingRequests=0,this.next("IDLE")},t.NETWORK_TIMEOUT))},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.increment=()=>{this.startCleanupTimeout(),0===this.pendingRequests&&this.next("BUSY"),this.pendingRequests+=1},this.decrement=()=>{this.abortCleanupTimeout(),1===this.pendingRequests?this.next("IDLE"):this.startCleanupTimeout(),this.pendingRequests=Math.max(this.pendingRequests-1,0),this.pendingRequests<10&&i.debug("AjaxIdleObservable.decrement()","::","pendingRequests =",this.pendingRequests)},this.subscribe=e=>(this.subscribers.add(e),()=>{this.subscribers.delete(e)})}}class n{constructor(){this.pendingResources=new Set,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{i.debug("ResourceLoadingIdleObservable.next()",e),this.subscribers.forEach(t=>t(e))},this.startCleanupTimeout=()=>{0!==t.NETWORK_TIMEOUT&&(this.abortCleanupTimeout(),this.cleanupTimeout=window.setTimeout(()=>{i.warn("ResourceLoadingIdleObservable","::","Timed out waiting for resources to resolve.","Consider filing a bug report if this continues to occur.","::","pendingResources =",this.pendingResources),this.didNetworkTimeOut=!0,this.pendingResources=new Set,this.next("IDLE")},t.NETWORK_TIMEOUT))},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.add=e=>{e instanceof HTMLImageElement&&!e.src||e instanceof HTMLImageElement&&e.complete||e instanceof HTMLLinkElement&&!e.href||e instanceof HTMLScriptElement&&!e.src||e instanceof HTMLIFrameElement&&!e.src||(this.startCleanupTimeout(),0===this.pendingResources.size&&this.next("BUSY"),this.pendingResources.add(e))},this.remove=e=>{this.abortCleanupTimeout(),this.pendingResources.delete(e),0===this.pendingResources.size?this.next("IDLE"):this.startCleanupTimeout(),this.pendingResources.size<10&&i.debug("ResourceLoadingIdleObservable.remove()","::","pendingResources =",this.pendingResources)},this.subscribe=e=>(this.subscribers.add(e),()=>{this.subscribers.delete(e)}),(null===window||void 0===window?void 0:window.MutationObserver)&&window.addEventListener("load",()=>{new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLScriptElement||e instanceof HTMLLinkElement||e instanceof HTMLImageElement||e instanceof HTMLIFrameElement?this.add(e):e.hasChildNodes()&&e instanceof HTMLElement&&e.querySelectorAll("img").forEach(this.add)})})}).observe(window.document.documentElement,{childList:!0,subtree:!0}),["load","error"].forEach(e=>{window.document.addEventListener(e,e=>{(e.target instanceof HTMLScriptElement||e.target instanceof HTMLLinkElement||e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&this.remove(e.target)},{capture:!0})})})}}class r{constructor(){this.ajaxIdleObservable=new s,this.resourceLoadingIdleObservable=new n,this.subscribers=new Set,this.ajaxIdle=!0,this.scriptLoadingIdle=!0,this.handleUpdate=e=>t=>{const i=this.ajaxIdle&&this.scriptLoadingIdle;"AJAX"===e&&(this.ajaxIdle="IDLE"===t),"RESOURCE_LOADING"===e&&(this.scriptLoadingIdle="IDLE"===t);const s=this.ajaxIdle&&this.scriptLoadingIdle;i!==s&&this.next(s?"IDLE":"BUSY")},this.next=e=>{i.debug("NetworkIdleObservable.next()",e),this.subscribers.forEach(t=>t(e))},this.incrementAjaxCount=()=>this.ajaxIdleObservable.increment(),this.decrementAjaxCount=()=>this.ajaxIdleObservable.decrement(),this.isIdle=()=>this.ajaxIdle&&this.scriptLoadingIdle,this.didNetworkTimeOut=()=>this.ajaxIdleObservable.didNetworkTimeOut||this.resourceLoadingIdleObservable.didNetworkTimeOut,this.resetDidNetworkTimeOut=()=>{this.ajaxIdleObservable.didNetworkTimeOut=!1,this.resourceLoadingIdleObservable.didNetworkTimeOut=!1},this.subscribe=e=>(this.subscribers.add(e),()=>{this.subscribers.delete(e)}),this.ajaxIdleObservable.subscribe(this.handleUpdate("AJAX")),this.resourceLoadingIdleObservable.subscribe(this.handleUpdate("RESOURCE_LOADING"))}}let o;const a=()=>(o||(o=new r),o);class d{constructor(e){this.mutationObserverConfig={attributeFilter:["hidden","style","src"],attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0},this.mutations=new Map,this.mutationObserverCallback=e=>{i.debug("InViewportMutationObserver.mutationObserverCallback()","::","mutations =",e),e.forEach(e=>{e.timestamp=performance.now();let t=null;e.target instanceof Element&&(t=e.target),e.target instanceof Text&&(t=e.target.parentElement),t&&("childList"===e.type?e.addedNodes.forEach(t=>{t instanceof HTMLElement&&(this.intersectionObserver.observe(t),this.mutations.set(t,e)),t instanceof Text&&null!=t.parentElement&&(this.intersectionObserver.observe(t.parentElement),this.mutations.set(t.parentElement,e))}):(this.intersectionObserver.observe(t),this.mutations.set(t,e)))})},this.intersectionObserverCallback=e=>{i.debug("InViewportMutationObserver.intersectionObserverCallback()","::","entries =",e),e.forEach(e=>{const t=this.mutations.get(e.target);e.isIntersecting&&null!=t&&(i.info("InViewportMutationObserver.callback()","::","mutation =",t),this.callback(t)),this.mutations.delete(e.target),this.intersectionObserver.unobserve(e.target)})},this.callback=e,this.mutationObserver=new MutationObserver(this.mutationObserverCallback),this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(e){i.info("InViewportMutationObserver.observe()","::","target =",e),this.mutationObserver.observe(e,this.mutationObserverConfig)}disconnect(){i.info("InViewportMutationObserver.disconnect()"),this.mutationObserver.disconnect(),this.intersectionObserver.disconnect()}}function c(e){const s=a();let n,r=s.isIdle();const o=e=>{r="IDLE"===e,r?(e=>{var t;(null!==(t=window.requestIdleCallback)&&void 0!==t?t:window.setTimeout)(()=>{window.requestAnimationFrame(()=>window.requestAnimationFrame(e))})})(d):(window.clearTimeout(n),n=void 0)},d=()=>{i.debug("requestAllIdleCallback.handleCpuIdle()"),r&&!n&&c()},c=()=>{n=window.setTimeout(()=>{const t=s.didNetworkTimeOut();s.resetDidNetworkTimeOut(),i.info("requestAllIdleCallback: ALL IDLE"),e(t),l()},t.IDLE_TIMEOUT)},l=s.subscribe(o);r&&o("IDLE")}class l{constructor(e){this.imageLoadTimes=new Map,this.lastImageLoadTimestamp=0,this.intersectionObserverCallback=e=>{e.forEach(e=>{const t=e.target,s=this.imageLoadTimes.get(t);e.isIntersecting&&null!=s&&(i.info("InViewportImageObserver.callback()","::","timestamp =",s),this.callback(s)),this.intersectionObserver.unobserve(t),this.imageLoadTimes.delete(t)})},this.handleLoadOrErrorEvent=e=>{(e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&(i.debug("InViewportImageObserver.handleLoadOrErrorEvent()","::","event =",e),this.imageLoadTimes.set(e.target,e.timeStamp),this.intersectionObserver.observe(e.target))},this.callback=e,this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(){i.info("InViewportImageObserver.observe()"),document.addEventListener("load",this.handleLoadOrErrorEvent,{capture:!0}),document.addEventListener("error",this.handleLoadOrErrorEvent,{capture:!0})}disconnect(){i.info("InViewportImageObserver.disconnect()"),this.lastImageLoadTimestamp=0,this.imageLoadTimes.clear(),this.intersectionObserver.disconnect(),document.removeEventListener("load",this.handleLoadOrErrorEvent),document.removeEventListener("error",this.handleLoadOrErrorEvent)}}class u{constructor(){if(this.debug=!1,this.idleTimeout=200,this.lastMutationTimestamp=0,this.lastImageLoadTimestamp=0,this.subscribers=new Set,this.navigationCount=0,this.getTTVC=e=>(this.subscribers.add(e),()=>this.subscribers.delete(e)),!u.isSupportedEnvironment())throw new Error("VisuallyCompleteCalculator: This browser/runtime is not supported.");this.inViewportMutationObserver=new d(e=>{var t;return this.lastMutationTimestamp=Math.max(this.lastMutationTimestamp,null!==(t=e.timestamp)&&void 0!==t?t:0)}),this.inViewportImageObserver=new l(e=>this.lastImageLoadTimestamp=Math.max(this.lastImageLoadTimestamp,e))}static isSupportedEnvironment(){var e;return void 0!==window&&"MutationObserver"in window&&"IntersectionObserver"in window&&"function"==typeof document.querySelectorAll&&(null===(e=window.performance)||void 0===e?void 0:e.timing)}async start(e=0){const t=this.navigationCount+=1;i.info("VisuallyCompleteCalculator.start()");let s=!1;const n=()=>s=!0;this.inViewportImageObserver.observe(),this.inViewportMutationObserver.observe(document.documentElement),window.addEventListener("pagehide",n),window.addEventListener("visibilitychange",n),window.addEventListener("locationchange",n),window.setTimeout(()=>{window.addEventListener("click",n),window.addEventListener("keydown",n)},0),await("complete"===document.readyState?Promise.resolve():new Promise(e=>{const t=()=>{e(),window.removeEventListener("load",t)};window.addEventListener("load",t)}));const r=await new Promise(c);if(!s){const t=Math.max(e,this.lastImageLoadTimestamp,this.lastMutationTimestamp);this.next({start:e,end:t,duration:t-e,detail:{didNetworkTimeOut:r}})}window.removeEventListener("pagehide",n),window.removeEventListener("visibilitychange",n),window.removeEventListener("locationchange",n),window.removeEventListener("click",n),window.removeEventListener("keydown",n),t===this.navigationCount&&(this.inViewportImageObserver.disconnect(),this.inViewportMutationObserver.disconnect())}next(e){e.end>Number.MAX_SAFE_INTEGER?i.warn("VisuallyCompleteCalculator.next()","::","This browser reported a time larger than MAX_SAFE_INTEGER. We are ignoring it.","::",e):(i.debug("VisuallyCompleteCalculator.next()","::","lastImageLoadTimestamp =",this.lastImageLoadTimestamp,"lastMutationTimestamp =",this.lastMutationTimestamp),i.info("TTVC:",e),this.subscribers.forEach(t=>t(e)))}}let m,h;const b=a().incrementAjaxCount,v=a().decrementAjaxCount;e.decrementAjaxCount=v,e.getTTVC=e=>null==h?void 0:h.getTTVC(e),e.incrementAjaxCount=b,e.init=e=>{(e=>{(null==e?void 0:e.debug)&&(t.DEBUG=e.debug),(null==e?void 0:e.idleTimeout)&&(t.IDLE_TIMEOUT=e.idleTimeout),(null==e?void 0:e.networkTimeout)&&(t.NETWORK_TIMEOUT=e.networkTimeout)})(e),i.info("init()"),m||(m=new u),h=m,h.start(),window.addEventListener("locationchange",()=>{h.start(performance.now())})},e.start=()=>null==h?void 0:h.start(performance.now()),Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=pkg-timing-helpers.min.js-vflvHwExa.map